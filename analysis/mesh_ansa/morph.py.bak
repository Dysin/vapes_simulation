'''
@Desc:   
@Author: Dysin
@Date:   2025/11/6
'''

import csv
import numpy as np
from ansa_utils import *

def str_to_list(str, scale = 1000):
    s_clean = str.strip('[]')  # 去除方括号
    result = [(float(num) * scale) for num in s_clean.split()]  # 分割并转换为float
    return result

def output_mesh(path, mesh_name):
    mesh_utils = Mesh()
    mesh_utils.output(
        path=path,
        file_name=mesh_name,
        type='nas'
    )
    mesh_utils.output(
        path=path,
        file_name=mesh_name,
        type='stl'
    )
    pshells = Entities('PSHELL')
    pshells_all = pshells.entities_all()

    for pshell in pshells_all:
        print(pshell._name)
        if pshell._name == 'outlet':
            pshell = pshells.get_entity(pshell._id)
            ansa.base.Or(pshell)
            mesh_utils.output(
                path=path,
                file_name=mesh_name + '_outlet',
                type='stl'
            )
        elif pshell._name == 'inlet':
            pshell = pshells.get_entity(pshell._id)
            ansa.base.Or(pshell)
            mesh_utils.output(
                path=path,
                file_name=mesh_name + '_inlet',
                type='stl'
            )
        elif pshell._name == 'atomizer_core':
            pshell = pshells.get_entity(pshell._id)
            ansa.base.Or(pshell)
            mesh_utils.output(
                path=path,
                file_name=mesh_name + '_atomizer_core',
                type='stl'
            )

def mesh_morph(
        path,
        ansa_name,
        delta_radius,
        name_id,
        csv_id
):
    csv_region_params = os.path.join(
        path_doe,
        'opt_region_params.csv'
    )
    file_data = open(csv_region_params, mode='r')
    df_regions = list(csv.reader(file_data))
    file_data.close()
    geo_utils = Geometry()
    base_utils = BaseUtils()
    morph_utils = MorphUtils()
    base_utils.new_project()
    base_utils.input_mesh(path, ansa_name, 'inp')
    base_utils.new_pid(1, 'inlet')
    pshell_utils = Entities('PSHELL')
    shell_utils = Entities('SHELL')
    set_utils = Entities('SET')
    pshell_dict = pshell_utils.get_all_entities_dict()
    all_sets = set_utils.entities_all()
    scale = 1000
    for i in range(1, len(df_regions)):
        region_name = 'opt_region' + str(i)
        pshell_region = pshell_dict.get(region_name)

        center1 = str_to_list(df_regions[i][1])
        center2 = str_to_list(df_regions[i][2])
        radius = float(df_regions[i][3]) * scale + 0.01
        print(center1, center2, radius)
        curve = geo_utils.create_line(center1, center2)
        morph = morph_utils.create_cylindrical_box(
            curve,
            radius1=radius,
            radius2=radius,
            pshells=pshell_region,
        )
        morph_utils.morph_status(True)
        morph_utils.morph_cylindrical(i, radius=delta_radius[i-1])

    faces_inlet = None
    for i in range(len(all_sets)):
        faces = Mesh().fill_gap_edges(all_sets[i], len(all_sets)+i+1)
        if all_sets[i]._name == 'edges_inlet':
            faces_inlet = faces

    for face in faces_inlet:
        base_utils.set_pid(face, 1)

    ansa.base.Not(pshell_dict.get('inlet'))
    ansa.base.Not(pshell_dict.get('outlet'))
    ansa.base.Not(pshell_dict.get('airflow_sensor'))
    ansa.base.Not(pshell_dict.get('atomizer_core'))
    shells_vis = shell_utils.entities_visible()
    for shell in shells_vis:
        base_utils.set_pid(
            shell,
            pshell_dict.get('wall')._id
        )
    ansa.base.All()
    base_utils.compress()
    mesh_name = ansa_name + '_b' + '{:02d}'.format(csv_id) + '_p' + "{:02d}".format(name_id)
    output_mesh(path, mesh_name)

if __name__ == '__main__':
    proj_name = 'VP353'
    ver_number = '20251201'
    csv_id = 1
    path_root = r'E:\1_Work\active\airway_analysis'
    path_data = os.path.join(path_root, proj_name, 'data')
    path_doe = os.path.join(path_root, proj_name, 'mesh', 'doe')
    nas_name = ver_number + '_airway'
    csv_input = os.path.join(
        path_data,
        ver_number + '_input_params_' + '{:02d}'.format(csv_id) + '.csv'
    )
    file_data = open(csv_input, mode='r')
    df = list(csv.reader(file_data))
    file_data.close()
    print('[INFO] Mesh name: ', nas_name)

    # 编号从1开始
    for i in range(1, len(df)):
        delta_r = np.array(df[i]).astype(float)
        print(delta_r)
        mesh_morph(path_doe, nas_name, delta_r, i, csv_id)